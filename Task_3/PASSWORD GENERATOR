import secrets
import string
import argparse
from datetime import datetime

def generate_password(length, exclude_similar=True):
    if length < 4:
        raise ValueError("Password length must be at least 4")

    lowercase = string.ascii_lowercase
    uppercase = string.ascii_uppercase
    digits = string.digits
    symbols = string.punctuation

    if exclude_similar:
        lowercase = lowercase.replace('l', '')
        uppercase = uppercase.replace('O', '')
        digits = digits.replace('0', '').replace('1', '')

    password = [
        secrets.choice(lowercase),
        secrets.choice(uppercase),
        secrets.choice(digits),
        secrets.choice(symbols),
    ]

    all_chars = lowercase + uppercase + digits + symbols
    password += [secrets.choice(all_chars) for _ in range(length - 4)]

    secrets.SystemRandom().shuffle(password)
    return ''.join(password)

def password_strength(password):
    score = 0

    if len(password) >= 12:
        score += 2
    elif len(password) >= 8:
        score += 1

    checks = [
        any(c.islower() for c in password),
        any(c.isupper() for c in password),
        any(c.isdigit() for c in password),
        any(c in string.punctuation for c in password)
    ]

    score += sum(checks)

    if score <= 2:
        return "Weak"
    elif score <= 4:
        return "Moderate"
    else:
        return "Strong"

def save_to_file(password):
    filename = "generated_passwords.txt"
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    with open(filename, "a") as file:
        file.write(f"[{timestamp}] {password}\n")

    return filename

def cli_mode():
    parser = argparse.ArgumentParser(description="Secure Password Generator")

    parser.add_argument("-l", "--length", type=int, help="Length of the password")
    parser.add_argument("-s", "--save", action="store_true", help="Save password to file")

    args = parser.parse_args()

    if args.length:
        password = generate_password(args.length)
        strength = password_strength(password)

        print("\nGenerated Password:")
        print(password)
        print(f"Strength: {strength}")

        if args.save:
            filename = save_to_file(password)
            print(f"Saved to {filename}")
    else:
        interactive_mode()

def interactive_mode():
    print("ðŸ” Secure Password Generator")

    while True:
        user_input = input("\nEnter password length (or 'q' to quit): ").strip()

        if user_input.lower() == 'q':
            print("Goodbye. Stay secure.")
            break

        try:
            length = int(user_input)
            password = generate_password(length)
            strength = password_strength(password)

            print(f"\nPassword: {password}")
            print(f"Strength: {strength}")

            save_choice = input("Save to file? (y/n): ").lower()
            if save_choice == 'y':
                filename = save_to_file(password)
                print(f"Saved to {filename}")

        except ValueError as e:
            print(f"Error: {e}")

if __name__ == "__main__":
    cli_mode()
